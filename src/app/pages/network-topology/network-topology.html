<div class="flex flex-row justify-between items-center mb-3">
    <div>
        <div class="text-3xl font-extrabold mb-2">Topologia de Rede</div>
        <div class="font-normal">Visão detalhada da infraestrutura e conectividade</div>
    </div>
</div>

<p-card>
    <div class="topology-container">
        <!-- Controles de Visualização -->
        <div class="topology-controls">
            <div class="control-group">
                <p-button 
                    icon="pi pi-plus" 
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="zoomIn()"
                    pTooltip="Aumentar Zoom"
                    tooltipPosition="left" />
                <p-button 
                    icon="pi pi-minus" 
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="zoomOut()"
                    pTooltip="Diminuir Zoom"
                    tooltipPosition="left" />
                <p-button 
                    icon="pi pi-refresh" 
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="resetZoom()"
                    pTooltip="Restaurar Zoom 1:1"
                    tooltipPosition="left" />
                <p-button 
                    [icon]="'pi pi-arrows-alt'" 
                    [severity]="isPanMode ? 'success' : 'secondary'"
                    [outlined]="!isPanMode"
                    (onClick)="togglePanMode()"
                    [pTooltip]="isPanMode ? 'Desativar Modo Pan (Arraste com Mouse)' : 'Ativar Modo Pan (Arraste com Mouse)'"
                    tooltipPosition="left" />
                <p-button 
                    icon="pi pi-file-pdf" 
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="exportToPDF()"
                    pTooltip="Exportar como PDF"
                    tooltipPosition="left" />
            </div>
        </div>
        
        <svg 
            #topologySvg
            [attr.viewBox]="'0 0 ' + svgWidth + ' ' + svgHeight"
            [attr.width]="svgWidth"
            [attr.height]="svgHeight"
            class="topology-svg"
            [style.cursor]="getCursor()"
            (mousedown)="onMouseDown($event)"
            (mousemove)="onMouseMove($event)"
            (mouseup)="onMouseUp($event)"
            (mouseleave)="onMouseUp($event)">
            
            <!-- Definições (gradientes, filtros, etc) -->
            <defs>
                <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                    <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.3"/>
                </filter>
            </defs>
            
            <!-- Grupo principal com transform para zoom e pan -->
            <g [attr.transform]="getTransform()">
                <!-- Conexões (linhas) - renderizadas primeiro para ficarem atrás dos nós -->
                <g class="connections">
                    <g *ngFor="let connection of connections" class="connection-group">
                        <!-- Linha de conexão -->
                        <path 
                            [attr.d]="getConnectionPath(connection)"
                            class="connection-line"
                            stroke="#64748b"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowhead)" />
                        
                        <!-- Labels de portas -->
                        <text 
                            [attr.x]="getFromPortLabelPosition(connection).x"
                            [attr.y]="getFromPortLabelPosition(connection).y"
                            class="port-label"
                            fill="#3b82f6">
                            {{ connection.fromPort }}
                        </text>
                        
                        <text 
                            [attr.x]="getToPortLabelPosition(connection).x"
                            [attr.y]="getToPortLabelPosition(connection).y"
                            class="port-label"
                            fill="#3b82f6">
                            {{ connection.toPort }}
                        </text>
                    </g>
                </g>
                
                <!-- Nós (dispositivos) -->
                <g class="nodes">
                    <g *ngFor="let node of nodes" 
                       [attr.transform]="'translate(' + (node.position?.x || 0) + ',' + (node.position?.y || 0) + ')'"
                       class="node-group"
                       [class]="getDeviceClass(node.type)">
                        
                        <!-- Retângulo do nó com borda -->
                        <rect 
                            x="0" 
                            y="0" 
                            [attr.width]="nodeWidth"
                            [attr.height]="nodeHeight"
                            class="node-rect"
                            rx="8"
                            ry="8"
                            fill="white"
                            stroke="#cbd5e1"
                            stroke-width="2"
                            filter="url(#shadow)" />
                        
                        <!-- Área do ícone (topo do retângulo) -->
                        <g class="node-icon-area">
                            <!-- Background do ícone -->
                            <rect 
                                x="0" 
                                y="0" 
                                [attr.width]="nodeWidth"
                                height="60"
                                class="icon-background"
                                rx="8"
                                ry="8"
                                fill="#f1f5f9" />
                            
                            <!-- Ícone SVG (usando foreignObject para usar classes do PrimeIcons) -->
                            <foreignObject 
                                [attr.x]="nodeWidth / 2 - 20" 
                                y="10" 
                                width="40" 
                                height="40">
                                <div xmlns="http://www.w3.org/1999/xhtml" class="flex items-center justify-center h-full">
                                    <i [class]="getDeviceIcon(node.type)" class="text-3xl text-gray-600"></i>
                                </div>
                            </foreignObject>
                        </g>
                        
                        <!-- Texto - Nome do dispositivo -->
                        <text 
                            [attr.x]="nodeWidth / 2"
                            y="75"
                            class="node-name"
                            text-anchor="middle"
                            fill="#1e293b"
                            font-weight="600"
                            font-size="14">
                            {{ node.name }}
                        </text>
                        
                        <!-- Texto - Modelo -->
                        <text 
                            [attr.x]="nodeWidth / 2"
                            y="92"
                            class="node-model"
                            text-anchor="middle"
                            fill="#64748b"
                            font-size="12">
                            {{ node.model }}
                        </text>
                        
                        <!-- Overlay para interatividade (hover/click) -->
                        <rect 
                            x="0" 
                            y="0" 
                            [attr.width]="nodeWidth"
                            [attr.height]="nodeHeight"
                            class="node-overlay"
                            rx="8"
                            ry="8"
                            fill="transparent"
                            stroke="transparent"
                            stroke-width="2"
                            style="cursor: pointer;" />
                    </g>
                </g>
            </g>
        </svg>
    </div>
</p-card>