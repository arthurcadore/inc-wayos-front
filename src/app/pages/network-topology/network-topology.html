<div class="mb-2 text-blue-500 text-lg cursor-pointer hover:underline">
    <a (click)="toBack()">
        <span class="pi pi-arrow-circle-left"></span> Voltar
    </a>
</div>
<div class="flex flex-row justify-between items-center mb-3">
    <div>
        <div class="text-3xl font-extrabold mb-2">Topologia de Rede</div>
        @if (routerDevice && routerDevice.inep) {
            <div class="font-bold">{{ routerDevice.inep }}</div>
        }
        @if(isLoading) {
            <p class="text-gray-500 mb-2">Atualizando...</p>
        }
    </div>
</div>

<p-card>
    <div class="topology-container">
        <!-- Controles de VisualizaÃ§Ã£o -->
        <div class="topology-controls">
            <div class="control-group">
                <p-button 
                    icon="pi pi-plus" 
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="zoomIn()"
                    pTooltip="Aumentar Zoom"
                    tooltipPosition="left" />
                <p-button 
                    icon="pi pi-minus" 
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="zoomOut()"
                    pTooltip="Diminuir Zoom"
                    tooltipPosition="left" />
                <p-button 
                    icon="pi pi-refresh" 
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="resetZoom()"
                    pTooltip="Restaurar Zoom 1:1"
                    tooltipPosition="left" />
                <p-button 
                    [icon]="'pi pi-arrows-alt'" 
                    [severity]="isPanMode ? 'success' : 'secondary'"
                    [outlined]="!isPanMode"
                    (onClick)="togglePanMode()"
                    [pTooltip]="isPanMode ? 'Desativar Modo Pan (Arraste com Mouse)' : 'Ativar Modo Pan (Arraste com Mouse)'"
                    tooltipPosition="left" />
                <p-button 
                    icon="pi pi-file-pdf" 
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="exportToPDF()"
                    pTooltip="Exportar como PDF"
                    tooltipPosition="left" />
            </div>
        </div>
        
        <svg 
            #topologySvg
            [attr.viewBox]="'0 0 ' + svgWidth + ' ' + svgHeight"
            [attr.width]="svgWidth"
            [attr.height]="svgHeight"
            class="topology-svg"
            [style.cursor]="getCursor()"
            (mousedown)="onMouseDown($event)"
            (mousemove)="onMouseMove($event)"
            (mouseup)="onMouseUp($event)"
            (mouseleave)="onMouseUp($event)">
            
            <!-- DefiniÃ§Ãµes (gradientes, filtros, etc) -->
            <defs>
                <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                    <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.2"/>
                </filter>
            </defs>

            <!-- Marcador de seta para conexÃµes -->
            <g [attr.transform]="getTransform()">
                <!-- ConexÃµes (linhas) - renderizadas primeiro para ficarem atrÃ¡s dos nÃ³s -->
                <g class="connections">
                    @for (connection of connections; track connection) {
                    <g class="connection-group">
                        <!-- Linha de conexÃ£o -->
                        <path 
                            [attr.d]="getConnectionPath(connection)"
                            class="connection-line"
                            stroke="#adadad"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowhead)" />
                    </g>
                    }
                </g>
            </g>
            
            <!-- Grupo principal com transform para zoom e pan -->
            <g [attr.transform]="getTransform()">
                <g class="connections">
                    @for (connection of connections; track connection) {
                        @if (connection.fromPort !== '' && connection.toPort !== '') {
                            <g  class="connection-group">
                                <!-- Labels de portas -->
                                <rect 
                                    [attr.x]="getFromPortLabelPosition(connection).x - 10"
                                    [attr.y]="getFromPortLabelPosition(connection).y - 14"
                                    [attr.width]="80"
                                    [attr.height]="20"
                                    fill="white"
                                    stroke="#3b82f6"
                                    stroke-width="1"
                                    rx="8"
                                    ry="8" />
                                <text 
                                    [attr.x]="getFromPortLabelPosition(connection).x"
                                    [attr.y]="getFromPortLabelPosition(connection).y"
                                    class="port-label"
                                    fill="#3b82f6">
                                    {{ connection.fromPort }}
                                </text>
                                
                                <rect 
                                    [attr.x]="getToPortLabelPosition(connection).x - 10"
                                    [attr.y]="getToPortLabelPosition(connection).y - 14"
                                    [attr.width]="80"
                                    [attr.height]="20"
                                    fill="white"
                                    stroke="#3b82f6"
                                    stroke-width="1"
                                    rx="8"
                                    ry="8" />
                                <text 
                                    [attr.x]="getToPortLabelPosition(connection).x"
                                    [attr.y]="getToPortLabelPosition(connection).y"
                                    class="port-label"
                                    fill="#3b82f6">
                                    {{ connection.toPort }}
                                </text>
                            </g>
                        }
                    }
                </g>
                
                <!-- NÃ³s (dispositivos) -->
                <g class="nodes">
                    @for (node of nodes; track node) {
                    <g [attr.transform]="'translate(' + (node.position?.x || 0) + ',' + (node.position?.y || 0) + ')'"
                       class="node-group"
                       [class]="getDeviceClass(node.type)">
                        
                        <!-- RetÃ¢ngulo do nÃ³ com borda -->
                        <rect 
                            x="0" 
                            y="0" 
                            [attr.width]="nodeWidth"
                            [attr.height]="nodeHeight"
                            class="node-rect"
                            rx="0"
                            ry="0"
                            fill="white"
                            stroke="#cbd5e1"
                            stroke-width="2"
                            filter="url(#shadow)" />
                        
                        <!-- Ãrea do Ã­cone (topo do retÃ¢ngulo) -->
                        <g class="node-icon-area">
                            <!-- Background do Ã­cone -->
                            <rect 
                                x="2.5" 
                                y="2.5" 
                                [attr.width]="nodeWidth - 5"
                                height="60"
                                class="icon-background"
                                rx="0"
                                ry="0"
                                fill="#f1f5f9" />
                            
                            <!-- Ãcone/Imagem do dispositivo -->
                            <image 
                                [attr.x]="nodeWidth / 2 - 55" 
                                y="-24" 
                                width="110" 
                                height="110"
                                [attr.href]="getDeviceImage(node.type)"
                                preserveAspectRatio="xMidYMid meet" />
                        </g>
                        
                        <!-- Texto - Nome do dispositivo -->
                        <text 
                            [attr.x]="nodeWidth / 2"
                            y="85"
                            class="node-name"
                            text-anchor="middle"
                            fill="#1e293b"
                            font-weight="600"
                            font-size="14">
                            {{ node.name }}
                        </text>
                        
                        <!-- Texto - Modelo -->
                        <text 
                            [attr.x]="nodeWidth / 2"
                            y="110"
                            class="node-model"
                            text-anchor="middle"
                            fill="#64748b"
                            font-size="12">
                            {{ node.model }}
                        </text>
                        
                        <!-- Texto - Status Online/Offline -->
                        @if (node.isOnline !== undefined) {
                        <text 
                            [attr.x]="nodeWidth / 2"
                            y="130"
                            [class]="node.isOnline ? 'node-status status-online' : 'node-status status-offline'"
                            text-anchor="middle"
                            font-weight="600"
                            font-size="12">
                            {{ node.isOnline ? 'ðŸŸ¢ Online' : 'ðŸ”´ Offline' }}
                        </text>
                        }
                        
                        <!-- Overlay para interatividade (hover/click) -->
                        <rect 
                            x="0" 
                            y="0" 
                            [attr.width]="nodeWidth"
                            [attr.height]="nodeHeight"
                            class="node-overlay"
                            rx="0"
                            ry="0"
                            fill="transparent"
                            stroke="transparent"
                            stroke-width="1"
                            style="cursor: pointer;"
                            (click)="showDeviceDetails($event, node)" />
                    </g>
                    }
                </g>
            </g>
        </svg>
        
        <!-- Ã‚ncora invisÃ­vel para posicionar o popover -->
        <div #popoverAnchor 
             style="position: absolute; width: 1px; height: 1px; pointer-events: none;">
        </div>
        
        <!-- Popover com detalhes do dispositivo -->
        <p-popover #devicePopover [dismissable]="true">
            <ng-template pTemplate="content">
                @if (routerDevice && selectedDevice && (selectedDevice.type === 'ROUTER')) {
                <div class="device-details">
                    <p class="text-lg font-bold mb-2">{{ getDeviceTypeName(selectedDevice.type) }}</p>
                    
                    <div class="flex justify-between bg-gray-50 p-2 mb-2">
                        <div class="text-sm font-bold text-gray-400">Nome</div>
                        <div class="text-sm font-bold">{{ routerDevice.model || '(n/d)' }}</div>
                    </div>

                    <div class="flex justify-between bg-gray-50 p-2 mb-2">
                        <div class="text-sm font-bold text-gray-400">Serial:</div>
                        <div class="text-sm font-bold">{{ routerDevice.sn || '(n/d)' }}</div>
                    </div>

                    <div class="flex justify-between bg-gray-50 p-2 mb-2">
                        <div class="text-sm font-bold text-gray-400">WAN IP:</div>
                        <div class="text-sm font-bold">{{ routerDevice.wanIp || '(n/d)' }}</div>
                    </div>

                    <div class="flex justify-between bg-gray-50 p-2 mb-2">
                        <div class="text-sm font-bold text-gray-400">LAN IP:</div>
                        <div class="text-sm font-bold">{{ routerDevice.lanIp || '(n/d)' }}</div>
                    </div>

                    <div class="flex justify-between bg-gray-50 p-2 mb-2">
                        <div class="text-sm font-bold text-gray-400">MAC:</div>
                        <div class="text-sm font-bold">{{ routerDevice.lanMac || '(n/d)' }}</div>
                    </div>

                    <div class="flex justify-between bg-gray-50 p-2 mb-2">
                        <div class="text-sm font-bold text-gray-400">On-line:</div>
                        <div class="text-sm font-bold">{{ routerDevice.online ? 'Sim' : 'NÃ£o' }}</div>
                    </div>
                </div>
                }

                @if (selectedDevice && selectedDevice.type !== 'ROUTER' && selectedDevice.type !== 'STATION') {
                <div class="device-details">
                    <div class="flex items-center gap-3 mb-3">
                        <div>
                            <h3 class="text-lg font-bold mb-1">{{ selectedDevice.name }}</h3>
                            <p class="text-sm text-gray-600">{{ getDeviceTypeName(selectedDevice.type) }}</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between bg-gray-50 p-2 mb-2">
                        <div class="text-sm font-bold text-gray-400">Nome</div>
                        <div class="text-sm font-bold">{{ selectedDevice.name || '(n/d)' }}</div>
                    </div>
                    <div class="flex justify-between bg-gray-50 p-2 mb-2">
                        <div class="text-sm font-bold text-gray-400">Modelo</div>
                        <div class="text-sm font-bold">{{ selectedDevice.model || '(n/d)' }}</div>
                    </div>
                    <div class="flex justify-between bg-gray-50 p-2 mb-2">
                        <div class="text-sm font-bold text-gray-400">Serial</div>
                        <div class="text-sm font-bold">{{ selectedDevice.sn || '(n/d)' }}</div>
                    </div>
                    <div class="flex justify-between bg-gray-50 p-2 mb-2">
                        <div class="text-sm font-bold text-gray-400">MAC</div>
                        <div class="text-sm font-bold">{{ selectedDevice.mac || '(n/d)' }}</div>
                    </div>
                    <div class="flex justify-between bg-gray-50 p-2 mb-2">
                        <div class="text-sm font-bold text-gray-400">Manage IP</div>
                        <div class="text-sm font-bold">{{ selectedDevice.manageIp || '(n/d)' }}</div>
                    </div>
                    <div class="flex justify-between bg-gray-50 p-2 mb-2">
                        <div class="text-sm font-bold text-gray-400">On-line:</div>
                        <div class="text-sm font-bold">{{ selectedDevice.isOnline ? 'Sim' : 'NÃ£o' }}</div>
                    </div>
                    
                    <div class="mb-2">
                        <p class="text-sm font-semibold text-gray-700 mb-2">ConexÃµes:</p>
                        <div class="space-y-2">
                            @for (port of selectedDevice.ports; track port) {
                            <div class="flex items-center justify-between text-sm bg-gray-50 p-2 rounded">
                                <span class="font-mono text-blue-600">{{ port.portName }}</span>
                                <span class="text-gray-400">â†’</span>
                                <div class="text-right">
                                    <div class="font-medium">{{ getConnectedDeviceName(port.connectedToDeviceId) }}</div>
                                    <div class="text-xs text-gray-500 font-mono">{{ port.connectedToPort }}</div>
                                </div>
                            </div>
                            }
                        </div>
                    </div>
                </div>
                }

                @if (selectedDevice && selectedDevice.type === 'STATION') {
                <div class="device-details">
                    <p class="text-lg font-bold mb-2">{{ getDeviceTypeName(selectedDevice.type) }}</p>

                    <div class="flex justify-between bg-gray-50 p-2 mb-2">
                        <div class="text-sm font-bold text-gray-400">Nome</div>
                        <div class="text-sm font-bold">{{ selectedDevice.model || '(n/d)' }}</div>
                    </div>

                    <div class="mb-2">
                        <p class="text-sm font-semibold text-gray-700 mb-2">ConexÃµes:</p>
                        <div class="space-y-2">
                            @for (port of selectedDevice.ports; track port) {
                            <div class="flex items-center justify-between text-sm bg-gray-50 p-2 rounded">
                                <span class="font-mono text-blue-600">{{ port.portName }}</span>
                                <span class="text-gray-400">â†’</span>
                                <div class="text-right">
                                    <div class="font-medium">{{ getConnectedDeviceName(port.connectedToDeviceId) }}</div>
                                    <div class="text-xs text-gray-500 font-mono">{{ port.connectedToPort }}</div>
                                </div>
                            </div>
                            }
                        </div>
                    </div>
                </div>
                }
            </ng-template>
        </p-popover>
    </div>
</p-card>