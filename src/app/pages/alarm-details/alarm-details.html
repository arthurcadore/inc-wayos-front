<div class="flex flex-row justify-between items-center mb-3">
    <div>
        <div class="text-3xl font-extrabold mb-2">Detalhes dos Alarmes</div>
        @if(isAlarmsLoading) {
        <p class="text-gray-500 mb-2">Atualizando...</p>
        }
    </div>
</div>
<p-card class="mb-3">
    @if (isViewGlobalLoading) {
    <p class="text-gray-500 mb-2">Atualizando...</p>
    }
    <div class="flex justify-between mb-2">
        <div>
            <span class="text-xl font-bold mr-2">{{ deviceTypeName }}</span>
            @if (deviceIsOnline) {
            <p-tag severity="success" value="Online" [rounded]="true" />
            } @else {
            <p-tag severity="danger" value="Offline" [rounded]="true" />
            }
        </div>
        <div>
            <a [routerLink]="['/']" class="text-green-500">Template do Firewall</a>
        </div>
    </div>
    <div class="mb-2">
        <span class="font-bold mr-2">Modelo:</span>
        <span>{{ deviceModel }}</span>
    </div>
    <div class="mb-2">
        <span class="font-bold mr-2">IP:</span>
        <span>{{ deviceIp }}</span>
    </div>
    <div class="mb-2">
        <span class="font-bold mr-2">NS:</span>
        <span>{{ deviceSn }}</span>
    </div>
    <div class="mb-2">
        <span class="font-bold mr-2">MAC:</span>
        <span>{{ deviceMac }}</span>
    </div>
</p-card>
<p-card>
    <div class="flex flex-col md:flex-row gap-4 my-5">
        <div class="">
            <p-selectbutton [options]="filterOptions" [(ngModel)]="selectedFilterOption" optionLabel="label" optionValue="value" (onChange)="applyFilter()" aria-labelledby="basic" />            
        </div>
        <p-button icon="pi pi-chevron-circle-up" [rounded]="true" [text]="true" (click)="collapseAlarms()" size="small" pTooltip="Fechar todos os alarmes" />
        <p-iconfield iconPosition="left" class="md:ml-auto w-full md:w-auto">
            <p-inputicon>
                <i class="pi pi-search"></i>
            </p-inputicon>
            <input pInputText type="text" (input)="searchAlarms($event)" placeholder="Pesquisar" />
        </p-iconfield>
    </div>

    @for (item of filteredAlarms; track item) {
    <p-panel [toggleable]="true" [(collapsed)]="item.collapsed" class="mb-4" [style]="{ background: '#ffdddd' }">
        <ng-template #header>
            <div class="flex justify-between items-center">
                <span class="pi pi-circle-fill mr-2" [style]="{ color: 'red' }"></span>
                <span class="font-bold mr-2">{{ item.title }}</span>
                <span class="text-gray-500 mr-2">{{ item.createdAt | date:'dd/MM/yyyy, HH:mm' }}</span>
                @if (item.isSolved === false) {
                <p-tag severity="danger" [style]="{ border: 'solid white 1px' }" [rounded]="true" value="Aberto" />
                }
                @if (item.isSolved === true) {
                <p-tag severity="success" [rounded]="true" value="Fechado" />
                }
            </div>
        </ng-template>

        <ng-template #icons>
            <p-button icon="pi pi-bars" severity="secondary" rounded text (click)="showPopupMenu(menu, $event, item)" />
            <p-menu #menu id="config_menu" [model]="menuItens" [popup]="true" />
        </ng-template>

        @for (comment of item.comments; track comment) {
        <p-card class="mb-2">
            <div class="flex justify-between items-center">
                <div>
                    <span class="text-gray-400 mr-1">{{ comment.createdAt | date:'dd/MM/yyyy, HH:mm' }}</span>
                    @if (comment.createdAt !== comment.updatedAt) {
                    <span class="text-gray-400 text-sm italic">(editado)</span>
                    }
                </div>
                @if (item.isSolved === false) {
                <div>
                    <p-button icon="pi pi-pencil" variant="text" severity="success" size="small" (click)="editComment(item, comment)"/>
                    <p-button icon="pi pi-times" variant="text" severity="danger" size="small" (onClick)="removeComment(item, comment, $event)" />
                </div>
                }
            </div>
            <hr>
            <pre style="white-space: pre-wrap; word-break: break-word; max-height: 160px; overflow-y: auto;">{{ comment.text }}</pre>
        </p-card>
        } @empty {
        <div class="text-red-600 text-center">Nenhum comentário disponível.</div>
        }
    </p-panel>
    } @empty {
    <div class="text-gray-500 text-center">Nenhum alarme disponível.</div>
    }
    <p-confirmpopup />
</p-card>
